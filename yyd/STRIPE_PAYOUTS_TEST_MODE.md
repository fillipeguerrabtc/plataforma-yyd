# üß™ Stripe Test Mode para Payouts - Guia Completo

## ‚úÖ **SIM! Voc√™ pode testar pagamentos de sal√°rios exatamente como testa compras de tours!**

Stripe oferece **n√∫meros de contas banc√°rias de teste** para simular payouts (pagamentos para funcion√°rios/guias) sem usar dinheiro real.

---

## üí° **RESUMO EXECUTIVO**

**Como funciona:**
1. ‚úÖ Use seu saldo de teste Stripe (dinheiro fict√≠cio da conta test mode)
2. ‚úÖ Use n√∫meros de conta banc√°ria **de teste** (n√£o precisa criar contas reais)
3. ‚úÖ Payouts s√£o processados instantaneamente em test mode (vs 2-3 dias em produ√ß√£o)
4. ‚úÖ N√£o precisa criar "subcontas" - usa n√∫meros fict√≠cios direto na API

**Diferen√ßa de Pagamentos de Tours:**
- **Tours**: Cliente paga ‚Üí Dinheiro entra no seu saldo Stripe
- **Sal√°rios**: Voc√™ paga ‚Üí Dinheiro sai do seu saldo Stripe

---

## üè¶ **CONTAS BANC√ÅRIAS DE TESTE**

### **Para Portugal/Europa (IBAN):**

Stripe **N√ÉO documenta** IBANs de teste espec√≠ficos oficialmente, mas voc√™ pode usar:

```
IBAN de teste gen√©rico: GB82 WEST 1234 5698 7654 32
BIC/SWIFT: TESTEFXXXXX
```

**OU** criar IBANs fict√≠cios v√°lidos usando geradores online (somente para test mode).

### **Para USA (Routing + Account Number):**

Estes s√£o os n√∫meros **oficiais** de teste do Stripe:

| Account Number | Routing Number | Resultado |
|----------------|----------------|-----------|
| `000123456789` | `110000000` | ‚úÖ Payout bem-sucedido |
| `000111111116` | `110000000` | ‚úÖ Payout bem-sucedido |
| `000111111113` | `110000000` | ‚ùå Payout falha (para testar erro) |

**‚ö†Ô∏è Importante:** Sempre inclua os zeros iniciais! `000123456789` n√£o `123456789`.

---

## üß™ **TESTANDO PAYOUTS NA PR√ÅTICA**

### **Op√ß√£o 1: Via Stripe Dashboard (Manual)**

1. Acesse: https://dashboard.stripe.com/test/balance
2. Verifique seu **Test Balance** (saldo de teste)
3. Se n√£o tiver saldo, fa√ßa um pagamento de teste primeiro
4. Clique em **"Payouts"** ‚Üí **"Create Manual Payout"**
5. Insira:
   - Amount: ‚Ç¨100 (ou qualquer valor)
   - Destination: Adicione conta banc√°ria de teste
   - Account Number: `000123456789`
   - Routing Number: `110000000`
6. Confirme ‚Üí Payout √© processado **instantaneamente** em test mode

### **Op√ß√£o 2: Via API (Autom√°tico - Recomendado)**

```typescript
// Exemplo: Pagar sal√°rio de ‚Ç¨1.500 para um funcion√°rio
import Stripe from 'stripe';

const stripe = new Stripe('sk_test_SEU_KEY_AQUI', {
  apiVersion: '2024-11-20.acacia',
});

// Criar payout (transfer√™ncia para conta banc√°ria)
const payout = await stripe.payouts.create({
  amount: 150000, // ‚Ç¨1.500 em centavos
  currency: 'eur',
  description: 'Sal√°rio Jo√£o Silva - Outubro 2025',
  metadata: {
    employee_id: 'emp_12345',
    payroll_id: 'payroll_october_2025',
    period: '2025-10',
  },
});

console.log('Payout ID:', payout.id); // po_xxxxx
console.log('Status:', payout.status); // 'pending' ‚Üí muda para 'paid' instantaneamente em test mode
console.log('Arrival Date:', payout.arrival_date); // Data de chegada (em test mode √© imediata)
```

**Resposta esperada (test mode):**

```json
{
  "id": "po_1ABC123test",
  "object": "payout",
  "amount": 150000,
  "currency": "eur",
  "status": "paid",
  "arrival_date": 1730419200,
  "description": "Sal√°rio Jo√£o Silva - Outubro 2025",
  "metadata": {
    "employee_id": "emp_12345",
    "payroll_id": "payroll_october_2025"
  }
}
```

---

## üîÑ **FLUXO COMPLETO DE TESTE**

### **Passo 1: Garantir Saldo de Teste**

Antes de fazer payouts, voc√™ precisa ter saldo na conta Stripe de teste:

```typescript
// Criar pagamento de teste (simulando venda de tour)
const paymentIntent = await stripe.paymentIntents.create({
  amount: 50000, // ‚Ç¨500
  currency: 'eur',
  payment_method: 'pm_card_visa', // Cart√£o de teste
  confirm: true,
  automatic_payment_methods: { enabled: true },
});

// Aguardar webhook confirmar ‚Üí saldo aumenta para ‚Ç¨500
```

**OU** use a Dashboard do Stripe para criar um pagamento manual de teste.

### **Passo 2: Criar Payout (Pagamento de Sal√°rio)**

```typescript
const payout = await stripe.payouts.create({
  amount: 150000, // ‚Ç¨1.500
  currency: 'eur',
  description: 'Sal√°rio Funcion√°rio',
});
```

### **Passo 3: Verificar Status**

```typescript
const status = await stripe.payouts.retrieve(payout.id);
console.log(status.status); // 'paid' (em test mode √© instant√¢neo)
```

---

## üéØ **TESTANDO CEN√ÅRIOS DIFERENTES**

### **1. Payout Bem-Sucedido**

```typescript
const payout = await stripe.payouts.create({
  amount: 100000,
  currency: 'eur',
  description: 'Teste: Payout Success',
});

// Status: 'paid' (instant√¢neo em test mode)
```

### **2. Payout Falhado (Simular Erro)**

Use a conta banc√°ria de teste que falha:

```typescript
// Primeiro, adicione external account que falha
const account = await stripe.accounts.create({
  type: 'custom',
  country: 'US',
  external_account: {
    object: 'bank_account',
    country: 'US',
    currency: 'usd',
    account_number: '000111111113', // Este n√∫mero causa falha
    routing_number: '110000000',
  },
});

// Agora criar payout vai falhar
const payout = await stripe.payouts.create({
  amount: 50000,
  currency: 'usd',
  stripe_account: account.id,
});

// Status: 'failed'
```

### **3. Payout Cancelado**

```typescript
const payout = await stripe.payouts.create({
  amount: 20000,
  currency: 'eur',
});

// Cancelar antes de processar (s√≥ funciona se status = 'pending')
const canceled = await stripe.payouts.cancel(payout.id);
console.log(canceled.status); // 'canceled'
```

---

## üîó **STRIPE CONNECT (Para M√∫ltiplos Guias)**

Se voc√™ quer que cada guia tenha sua pr√≥pria "conta" para receber pagamentos automaticamente:

### **Criar Conta Connected de Teste**

```typescript
// Criar conta para um guia
const connectedAccount = await stripe.accounts.create({
  type: 'express', // Tipo mais simples
  country: 'PT',
  email: 'guia.teste@example.com',
  capabilities: {
    card_payments: { requested: true },
    transfers: { requested: true },
  },
  business_type: 'individual',
  external_account: {
    object: 'bank_account',
    country: 'PT',
    currency: 'eur',
    account_holder_name: 'Jo√£o Silva',
    account_number: 'PT50000000000000000000000', // IBAN de teste
  },
});

console.log('Connected Account ID:', connectedAccount.id); // acct_xxxxx
```

### **Transferir Dinheiro para Conta do Guia**

```typescript
// Transferir ‚Ç¨200 de comiss√£o para o guia
const transfer = await stripe.transfers.create({
  amount: 20000, // ‚Ç¨200
  currency: 'eur',
  destination: connectedAccount.id, // ID da conta do guia
  description: 'Comiss√£o - Tour Full Day',
  metadata: {
    tour_id: 'tour_12345',
    guide_name: 'Jo√£o Silva',
  },
});
```

### **Guia Faz Payout para Sua Conta Banc√°ria**

```typescript
// Criar payout NA CONTA DO GUIA (on behalf of)
const payout = await stripe.payouts.create(
  {
    amount: 20000, // Sacar ‚Ç¨200
    currency: 'eur',
  },
  {
    stripeAccount: connectedAccount.id, // Fazer payout da conta do guia
  }
);
```

---

## üìã **CHECKLIST DE TESTE**

Use este checklist para validar o sistema de payouts:

- [ ] **1. Saldo dispon√≠vel:** Verificar que tem saldo de teste suficiente
- [ ] **2. Criar payout simples:** ‚Ç¨100 para conta de teste
- [ ] **3. Verificar status:** Confirmar que muda para `paid` instantaneamente
- [ ] **4. Testar payout falhado:** Usar conta que falha (n√∫mero `000111111113`)
- [ ] **5. Cancelar payout:** Criar e cancelar antes de processar
- [ ] **6. Metadados:** Adicionar `employee_id`, `payroll_id`, etc.
- [ ] **7. Webhook:** Configurar webhook para `payout.paid` / `payout.failed`
- [ ] **8. Listar payouts:** Buscar hist√≥rico de pagamentos
- [ ] **9. Stripe Connect (opcional):** Criar conta connected de teste
- [ ] **10. Transfer (opcional):** Transferir para conta connected

---

## üìä **WEBHOOKS PARA PAYOUTS**

Configure webhooks para receber notifica√ß√µes em tempo real:

**Eventos importantes:**
- `payout.created` - Payout criado
- `payout.paid` - Payout chegou na conta (bem-sucedido)
- `payout.failed` - Payout falhou
- `payout.canceled` - Payout foi cancelado
- `payout.updated` - Status do payout mudou

**Endpoint de teste:** `/api/webhooks/stripe-payouts`

```typescript
// Exemplo de webhook handler
export async function POST(request: Request) {
  const body = await request.text();
  const sig = request.headers.get('stripe-signature');
  
  const event = stripe.webhooks.constructEvent(
    body,
    sig!,
    process.env.STRIPE_WEBHOOK_SECRET!
  );
  
  if (event.type === 'payout.paid') {
    const payout = event.data.object;
    
    // Atualizar payroll no database
    await prisma.payroll.updateMany({
      where: { stripePayoutId: payout.id },
      data: { 
        status: 'completed',
        paidAt: new Date(),
      },
    });
    
    console.log(`‚úÖ Payout ${payout.id} confirmado`);
  }
  
  if (event.type === 'payout.failed') {
    const payout = event.data.object;
    
    await prisma.payroll.updateMany({
      where: { stripePayoutId: payout.id },
      data: { status: 'failed' },
    });
    
    console.log(`‚ùå Payout ${payout.id} falhou:`, payout.failure_message);
  }
  
  return NextResponse.json({ received: true });
}
```

---

## üÜö **COMPARA√á√ÉO: TOURS vs SAL√ÅRIOS**

| Aspecto | Compra de Tours | Pagamento de Sal√°rios |
|---------|-----------------|------------------------|
| **Dire√ß√£o** | Cliente ‚Üí Voc√™ | Voc√™ ‚Üí Funcion√°rio |
| **API** | `PaymentIntents` | `Payouts` |
| **Cart√£o de Teste** | `4242 4242 4242 4242` | N/A |
| **Conta de Teste** | N/A | `000123456789` |
| **Saldo Stripe** | Aumenta | Diminui |
| **Tempo (test)** | Instant√¢neo | Instant√¢neo |
| **Tempo (prod)** | Instant√¢neo | 2-3 dias |
| **Webhook** | `payment_intent.succeeded` | `payout.paid` |

---

## üí∞ **CUSTOS (Produ√ß√£o)**

| Tipo | Tempo | Custo |
|------|-------|-------|
| **Standard Payout** | 2-3 dias | 0.25% (m√°x ‚Ç¨5) |
| **Instant Payout** | 30 min | 1.5% |
| **International** | 3-5 dias | Varia |

**Em test mode:** TUDO √â GR√ÅTIS! üéâ

---

## üöÄ **IMPLEMENTA√á√ÉO R√ÅPIDA**

Se quiser implementar agora no backoffice:

### **1. Adicionar campos ao Employee:**

```typescript
// shared/schema.ts
export const employees = pgTable('employees', {
  // ... campos existentes
  
  // Dados para payouts
  bankAccountName: varchar('bank_account_name'),
  bankAccountNumber: varchar('bank_account_number'), // IBAN ou account number
  bankRoutingNumber: varchar('bank_routing_number'), // BIC ou routing
  stripeConnectedAccountId: varchar('stripe_connected_account_id'),
});
```

### **2. API Route de Payout:**

```typescript
// app/api/payroll/payout/route.ts
export async function POST(request: NextRequest) {
  const { payrollId } = await request.json();
  
  const payroll = await prisma.payroll.findUnique({
    where: { id: payrollId },
    include: { employee: true },
  });
  
  // Criar payout
  const payout = await stripe.payouts.create({
    amount: Math.round(payroll.netPay * 100),
    currency: 'eur',
    description: `Sal√°rio ${payroll.employee.name}`,
    metadata: {
      payroll_id: payrollId,
      employee_id: payroll.employeeId,
    },
  });
  
  // Atualizar payroll
  await prisma.payroll.update({
    where: { id: payrollId },
    data: {
      stripePayoutId: payout.id,
      status: 'paid',
      paidAt: new Date(),
    },
  });
  
  return NextResponse.json({ success: true, payout });
}
```

### **3. Bot√£o no Frontend:**

```typescript
async function payViaStripe(payrollId: string) {
  const res = await fetch('/api/payroll/payout', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ payrollId }),
  });
  
  const data = await res.json();
  alert(`‚úÖ Pagamento processado! ID: ${data.payout.id}`);
}
```

---

## ‚úÖ **CONCLUS√ÉO**

**RESPOSTA DIRETA:**

‚úÖ **SIM!** Voc√™ pode testar pagamentos de sal√°rios via Stripe usando:
- Saldo de teste (dinheiro fict√≠cio)
- N√∫meros de conta banc√°ria de teste (`000123456789`)
- Tudo funciona IGUAL aos pagamentos de tours, s√≥ que na dire√ß√£o oposta

**N√ÉO precisa:**
- ‚ùå Criar contas banc√°rias reais
- ‚ùå Pedir para funcion√°rios criarem contas Stripe
- ‚ùå Usar dinheiro real

**Basta:**
1. ‚úÖ Usar sua chave `sk_test_...`
2. ‚úÖ Usar n√∫meros de conta de teste
3. ‚úÖ Criar payouts via API
4. ‚úÖ Verificar status ‚Üí ser√° `paid` instantaneamente

---

**Quer que eu implemente o sistema completo de Stripe Payouts no backoffice agora?** üöÄ

Posso adicionar:
- ‚úÖ Campos de conta banc√°ria para funcion√°rios
- ‚úÖ Bot√£o "Pagar via Stripe" na tela de Payroll
- ‚úÖ API completa com payouts
- ‚úÖ Teste com n√∫meros de teste
- ‚úÖ Webhooks para confirma√ß√£o
